name: MuleSoft CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      javaVersion:
        description: "Java version to use (8 or 17)"
        required: true
        default: "17"
      anypointUri:
        description: "Base URI for Anypoint"
        required: true
        default: "https://anypoint.mulesoft.com"
      provider:
        description: "Provider (e.g., MC)"
        required: true
        default: "MC"
      environment:
        description: "Environment name"
        required: true
        default: "Sandbox"
      target:
        description: "Target for CloudHub 2.0 deployment"
        required: true
      appName:
        description: "Application name for CloudHub deployment"
        required: true
      replicas:
        description: "Number of replicas to deploy"
        required: false
        default: "1"
      vCores:
        description: "vCores for CloudHub application"
        required: false
        default: "0.1"

jobs:
  build:
    name: Build Mule Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ github.event.inputs.javaVersion }}

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Build Mule app
        run: mvn clean package -DskipTests=true --settings settings.xml

  publish:
    name: Publish to Exchange
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ github.event.inputs.javaVersion }}

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Configure environment variables
        run: |
          echo "ANYPOINT_URI=${{ github.event.inputs.anypointUri }}" >> $GITHUB_ENV
          echo "ANYPOINT_PROVIDER=${{ github.event.inputs.provider }}" >> $GITHUB_ENV
          echo "ANYPOINT_ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "ANYPOINT_TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ github.event.inputs.appName }}" >> $GITHUB_ENV
          echo "APP_REPLICAS=${{ github.event.inputs.replicas }}" >> $GITHUB_ENV
          echo "APP_VCORES=${{ github.event.inputs.vCores }}" >> $GITHUB_ENV

      - name: Publish to Exchange
        env:
          ANYPOINT_CONNECTED_APP_CLIENT_ID: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_ID }}
          ANYPOINT_CONNECTED_APP_CLIENT_SECRET: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_SECRET }}
        run: mvn clean deploy --settings settings.xml

  deploy:
    name: Deploy to CloudHub 2.0
    runs-on: ubuntu-latest
    needs: publish

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ github.event.inputs.javaVersion }}

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Deploy to CloudHub 2.0
        env:
          ANYPOINT_CONNECTED_APP_CLIENT_ID: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_ID }}
          ANYPOINT_CONNECTED_APP_CLIENT_SECRET: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_SECRET }}
          ANYPOINT_URI: ${{ github.event.inputs.anypointUri }}
          ANYPOINT_PROVIDER: ${{ github.event.inputs.provider }}
          ANYPOINT_ENVIRONMENT: ${{ github.event.inputs.environment }}
          ANYPOINT_TARGET: ${{ github.event.inputs.target }}
          APP_NAME: ${{ github.event.inputs.appName }}
          APP_REPLICAS: ${{ github.event.inputs.replicas }}
          APP_VCORES: ${{ github.event.inputs.vCores }}
        run: |
          mvn clean deploy -DmuleDeploy \
            -Danypoint.uri=${{ env.ANYPOINT_URI }} \
            -Danypoint.provider=${{ env.ANYPOINT_PROVIDER }} \
            -Danypoint.env=${{ env.ANYPOINT_ENVIRONMENT }} \
            -Danypoint.target=${{ env.ANYPOINT_TARGET }} \
            -Dapp.name=${{ env.APP_NAME }} \
            -Dapp.replicas=${{ env.APP_REPLICAS }} \
            -Dapp.vcores=${{ env.APP_VCORES }} \
            --settings settings.xml
